#!/bin/bash

if [[ $1 == "configure" ]]; then

    if [ "$(findmnt -o FSTYPE -n /)" = btrfs ]; then
        if [ -x /usr/sbin/btrfs-auto-snapshot ]; then
            btrfs-auto-snapshot list | grep -wq home/@ || { btrfs-auto-snapshot createvol home; btrfs-auto-snapshot createvol home/@; }
            mountpoint -q /home || mount -o subvol=home/@,noatime $(findmnt -n -o SOURCE -v /) /home || exit 2
        fi
    fi

    grep -wq input /etc/group || groupadd input || :
    grep -wq audio /etc/group || groupadd audio || :
    grep -wq xbian /etc/passwd || useradd -G audio,video,users,input,sudo -m -p paI8KFtCOiEM6 -s /bin/bash -d /home/xbian xbian 2>/dev/null

    if [ -d /home/xbian/.xbmc.preserve ]; then
        while test -d /home/xbian/.xbmc; do rm -fr /home/xbian/.xbmc; sleep 1; done
        mv /home/xbian/.xbmc.preserve /home/xbian/.xbmc
    fi

    [ -d /home/xbian ] && chown -R xbian:xbian /home/xbian >/dev/null 2>&1

elif [ $1 = triggered ]; then

    :

fi

exit 0
