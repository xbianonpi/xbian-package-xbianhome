#!/bin/bash

if [[ $1 == "configure" ]]; then

    grps="input audio cdrom video"

    if [ "$(findmnt -o FSTYPE -n /)" = btrfs ]; then
        if [ -x /usr/sbin/btrfs-auto-snapshot ]; then
            btrfs-auto-snapshot list | grep -wq home/@ || { btrfs-auto-snapshot createvol home; btrfs-auto-snapshot createvol home/@; }
            mountpoint -q /home || mount -o subvol=home/@,noatime $(findmnt -n -o SOURCE -v /) /home || exit 2
        fi
    fi

    if ! grep -wq xbian /etc/passwd; then
        useradd -G users,sudo -m -s /bin/bash -d /home/xbian xbian 2>/dev/null
        echo "xbian:raspberry" | chpasswd
    else
        # This could trigger a passchange on each update on md4 systems
        # but that doesn't matter much. The final result will be the same.
        grep -wq "xbian:paI8KFtCOiEM6" /etc/shadow && echo "xbian:raspberry" | chpasswd
    fi

    # add groups if not exist, add xbian user to it
    for g in $grps; do
        grep -wq $g /etc/group || groupadd --system $g || :
        usermod -G $g -a xbian || :
    done

    if [ -d /home/xbian/.xbmc.preserve ]; then
        while test -d /home/xbian/.xbmc; do rm -fr /home/xbian/.xbmc; sleep 1; done
        mv /home/xbian/.xbmc.preserve /home/xbian/.xbmc
    fi

    [ -d /home/xbian ] && chown -R xbian:xbian /home/xbian >/dev/null 2>&1

elif [ $1 = triggered ]; then

    :

fi

exit 0
